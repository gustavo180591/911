{% extends 'base.html.twig' %}

{% block title %}Registrar Denuncia{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-4">Registrar Nueva Denuncia</h1>

    {# Mensajes flash de error #}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    {{ form_start(form, { attr: { 'data-turbo': 'false' } }) }}

    {# Descripción #}
    <div class="mb-3">
        {{ form_label(form.descripcion) }}
        {{ form_widget(form.descripcion) }}
        {{ form_errors(form.descripcion) }}
    </div>

    {# Fecha/Hora #}
    <div class="mb-3">
        {{ form_label(form.fechaHora) }}
        {{ form_widget(form.fechaHora) }}
        {{ form_errors(form.fechaHora) }}
    </div>

    {# Sub-form Ubicacion #}
    <h3>Datos de Ubicación</h3>
    <div class="mb-3">
        {{ form_row(form.ubicacion.calle) }}
    </div>
    <div class="mb-3">
        {{ form_row(form.ubicacion.numero) }}
    </div>
    <div class="mb-3">
        {{ form_row(form.ubicacion.detalles) }}
    </div>
    {# El campo "coordenadas" es hidden #}
    {{ form_widget(form.ubicacion.coordenadas) }}

    {# Mapa Leaflet #}
    <div id="map" style="width:100%;height:400px;"></div>

    {# Evidencias #}
    <div class="mb-3 mt-3">
        <h4>Archivos de Evidencia</h4>

        {# MODO SIMPLE: sin botón de agregar #}
        {{ form_row(form.evidencias) }}

        {# Si quisieras botón para añadir subforms dinámicos, #}
           haz algo como:
           <div id="evidencias-container" data-prototype="{{ form_widget(form.evidencias.vars.prototype)|e('html_attr') }}">
               {% for evid in form.evidencias %}
                   {{ form_row(evid) }}
               {% endfor %}
           </div>
           <button type="button" class="btn btn-secondary" id="add-evid-btn">Agregar Evidencia</button>
        
    </div>

    {# Botón Registrar #}
    <button type="submit" class="btn btn-primary">
        {{ form.submit.vars.label|default('Registrar') }}
    </button>

    {{ form_end(form) }}

    <div class="mt-3">
        <a href="{{ path('emergency_index') }}" class="btn btn-secondary">Volver a la Lista</a>
    </div>
</div>

{# Librerías Leaflet #}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<script>
(function() {
    let map;
    let marker;

    document.addEventListener('DOMContentLoaded', () => {
        initializeMap();
    });

    function initializeMap() {
        // Centro en Misiones aprox.
        map = L.map('map').setView([-27.362778, -55.900555], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const redIcon = L.icon({
            iconUrl: '/images/marker-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        marker = L.marker([-27.362778, -55.900555], {
            draggable: true,
            icon: redIcon
        }).addTo(map).bindPopup('Ubicación aproximada').openPopup();

        // Click en mapa => mover marcador y actualizar coordenadas
        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            marker.setLatLng([lat, lng]).openPopup();
            document.getElementById('{{ form.ubicacion.coordenadas.vars.id }}').value = lat + ',' + lng;
        });

        // Al arrastrar el marcador, actualiza coordenadas
        marker.on('moveend', (e) => {
            const { lat, lng } = e.target.getLatLng();
            document.getElementById('{{ form.ubicacion.coordenadas.vars.id }}').value = lat + ',' + lng;
        });
    }
})();
</script>
{% endblock %}
