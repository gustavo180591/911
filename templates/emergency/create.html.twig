{% extends 'base.html.twig' %}

{% block title %}Registrar Emergencia{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1 class="mb-4">Registrar Nueva Emergencia</h1>

    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">
            {{ message }}
        </div>
    {% endfor %}

    {{ form_start(form, { attr: { 'data-turbo': 'false' } }) }} {# üö® Deshabilitamos Turbo Drive para evitar reinicializaci√≥n del mapa #}

    <div class="mb-3">
        {{ form_label(form.descripcion, 'Descripci√≥n de la Emergencia') }}
        {{ form_widget(form.descripcion, { 'attr': {'class': 'form-control'} }) }}
        {{ form_errors(form.descripcion) }}
    </div>

    <div class="mb-3">
        {{ form_label(form.fechaHora, 'Fecha y Hora del Incidente') }}
        {{ form_widget(form.fechaHora, { 'attr': {'class': 'form-control', 'readonly': 'readonly'} }) }}
        {{ form_errors(form.fechaHora) }}
    </div>

    <div class="mb-3">
        <label for="direccion-input" class="form-label">Direcci√≥n</label>
        <input type="text" id="direccion-input" name="direccion" class="form-control" placeholder="Escribe la direcci√≥n..." required />
    </div>

    <input type="hidden" id="latitud" name="latitud">
    <input type="hidden" id="longitud" name="longitud">

    <div id="map-container" style="position: relative; min-height: 400px;">
        <div id="map"></div>
    </div>

    <button type="submit" class="btn btn-primary">Registrar</button>

    {{ form_end(form) }}

    <div class="mt-3">
        <a href="{{ path('emergency_index') }}" class="btn btn-secondary">Volver a la Lista de Emergencias</a>
    </div>
</div>

{# ‚úÖ Agregamos los archivos de Leaflet.js #}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    #map {
        width: 100%;
        height: 400px;
        background: #f0f0f0;
        border: 2px dashed #ccc;
    }
</style>

<script>
(function () {
    let map = null;
    let marker = null;

    document.addEventListener("turbo:load", () => {
        cleanupMap();
        initializeMap();
    });

    document.addEventListener("turbo:before-cache", cleanupMap);

    function initializeMap() {
        const mapContainer = document.getElementById('map');
        
        if (!mapContainer) return;
        if (map !== null) {
            console.warn("‚ö†Ô∏è Mapa ya inicializado, se evita duplicaci√≥n.");
            return;
        }

        console.log("üåç Inicializando Leaflet.js");

        // Inicializar mapa
        map = L.map('map').setView([-27.362778, -55.900555], 13);

        // Cargar capa de mapa
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Configurar marcador
        const redIcon = L.icon({
            iconUrl: '/images/marker-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        marker = L.marker([-27.362778, -55.900555], {
            draggable: true,
            icon: redIcon
        }).addTo(map).bindPopup('Posadas, Misiones').openPopup();

        setupMapEvents();
        setupAddressInput();
    }

    function cleanupMap() {
        if (map) {
            console.log("üßπ Eliminando mapa antes de salir de la p√°gina");
            map.remove();
            map = null;
            marker = null;
        }
    }

    function setupMapEvents() {
        map.on('click', (e) => {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            marker.setLatLng([lat, lon]).openPopup();
            document.getElementById('latitud').value = lat;
            document.getElementById('longitud').value = lon;
            
            reverseGeocode(lat, lon);
        });
    }

    function setupAddressInput() {
        const direccionInput = document.getElementById('direccion-input');
        direccionInput.addEventListener('change', () => {
            geocodeAddress(direccionInput.value);
        });
    }

    async function reverseGeocode(lat, lon) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await response.json();
            const address = data.address || {};
            document.getElementById('direccion-input').value = 
                `${address.road || ''} ${address.house_number || ''}, ${address.city || 'Posadas'}`;
        } catch (error) {
            console.error('‚ùå Error en geocoding inverso:', error);
        }
    }

    async function geocodeAddress(address) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const data = await response.json();
            
            if (data.length > 0) {
                const lat = data[0].lat;
                const lon = data[0].lon;
                
                document.getElementById('latitud').value = lat;
                document.getElementById('longitud').value = lon;
                marker.setLatLng([lat, lon]).bindPopup(address).openPopup();
                map.setView([lat, lon], 15);
            }
        } catch (error) {
            console.error('‚ùå Error en geocoding:', error);
        }
    }
})();
</script>
{% endblock %}
